{% extends "base.html" %}

{% block content %}

<div class="container-fluid">
    <div class="row mb-4">
        <!-- Left Column -->
        <div class="col-lg-5">
            <!-- Current Month Budget Overview (Donut Chart) -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2" style="color: #0ea5e9;"></i>Current Month Budget</h5>
                    <div>
                        <span id="current-month" class="badge bg-secondary">{{ now.strftime('%B %Y') }}</span>
                    </div>
                </div>
                <div class="card-body text-center">
                    <div id="budget-donut-container" style="height: 300px;">
                        <!-- Donut chart will be rendered here -->
                    </div>
                    
                    <!-- Summary stats under donut -->
                    <div class="row mt-3">
                        <div class="col-4">
                            <h6 class="text-muted">Total Budget</h6>
                            <h4 id="total-month-budget">{{ base_currency.symbol }}{{ "%.2f"|format(total_month_budget|default(0)) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-muted">Total Spent</h6>
                            <h4 id="total-month-spent">{{ base_currency.symbol }}{{ "%.2f"|format(total_month_spent|default(0)) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-muted">Remaining</h6>
                            <h4 id="total-month-remaining" class="{% if (total_month_budget|default(0) - total_month_spent|default(0)) < 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ base_currency.symbol }}{{ "%.2f"|format((total_month_budget|default(0) - total_month_spent|default(0))|abs) }}
                                {% if (total_month_budget|default(0) - total_month_spent|default(0)) < 0 %}<i class="fas fa-arrow-down text-danger"></i>{% endif %}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget List Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2" style="color: #0ea5e9;"></i>Your Budgets</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">{{ budget_data|length }} budgets</span>
                        <button id="toggleBudgetForm" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-2"></i>Add Budget
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if budget_data %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Budget</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in budget_data %}
                                        {% set budget = data.budget %}
                                        <tr class="budget-row" data-budget-id="{{ budget.id }}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if budget.category %}
                                                        <span class="badge me-2" style="background-color: {{ budget.category.color }};">
                                                            <i class="fas {{ budget.category.icon }}"></i>
                                                        </span>
                                                        <span class="budget-name">{{ budget.name or budget.category.name }}</span>
                                                    {% else %}
                                                        <span class="text-muted">Unknown category</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {{ base_currency.symbol }}{{ "%.2f"|format(budget.amount) }}
                                                <small class="d-block text-muted">{{ budget.period|capitalize }}</small>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 8px; width: a00px;">
                                                    <div class="progress-bar 
                                                        {% if data.status == 'over' %}bg-danger
                                                        {% elif data.status == 'approaching' %}bg-warning
                                                        {% else %}bg-success{% endif %}" 
                                                        role="progressbar" 
                                                        style="width: {{ data.percentage }}%;" 
                                                        aria-valuenow="{{ data.percentage }}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100"></div>
                                                </div>
                                                <small class="d-block mt-1">{{ "%.1f"|format(data.percentage) }}% 
                                                    ({{ base_currency.symbol }}{{ "%.2f"|format(data.spent) }})
                                                </small>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="budgetAction{{ budget.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end bg-dark" aria-labelledby="budgetAction{{ budget.id }}">
                                                        <li>
                                                            <a class="dropdown-item text-light" href="#" onclick="editBudget({{ budget.id }}); return false;">
                                                                <i class="fas fa-edit me-2"></i>Edit
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <form action="{{ url_for('toggle_budget', budget_id=budget.id) }}" method="POST" class="d-inline">
                                                                <button type="submit" class="dropdown-item {% if budget.active %}text-warning{% else %}text-success{% endif %}">
                                                                    <i class="fas {% if budget.active %}fa-pause{% else %}fa-play{% endif %} me-2"></i>
                                                                    {% if budget.active %}Deactivate{% else %}Activate{% endif %}
                                                                </button>
                                                            </form>
                                                        </li>
                                                        <li><hr class="dropdown-divider border-secondary"></li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" href="#" onclick="deleteBudget({{ budget.id }}); return false;">
                                                                <i class="fas fa-trash-alt me-2"></i>Delete
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">You haven't created any budgets yet. Click the "Add Budget" button to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-7">
            <!-- Monthly Budget Trends Chart -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2" style="color: #0ea5e9;"></i>Monthly Budget Trends</h5>
                    <div id="budget-selection-info">
                        <span id="selected-budget-name">All Budgets</span>
                        <button id="reset-budget-selection" class="btn btn-sm btn-secondary ms-2" style="display: none;">
                            Reset
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chart Container -->
                    <div id="budget-chart-container" style="height: 300px;">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Transactions -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2" style="color: #0ea5e9;"></i>Related Transactions</h5>
                    <div>
                        <span id="transaction-count-badge" class="badge bg-secondary">0 transactions</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="budget-transactions-container">
                        <div class="text-center py-4">
                            <p class="text-muted">Select a budget to view related transactions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budget Form (Hidden initially) -->
<div id="budgetFormContainer" class="card mb-4" style="display: none;">
    <div class="card-header">
        <h4 class="mb-0">Add New Budget</h4>
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_budget') }}" method="POST">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="name" class="form-label">Budget Name (Optional)</label>
                    <input type="text" class="form-control bg-dark text-light" id="name" name="name" placeholder="E.g., Monthly Groceries">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="amount" class="form-label">Budget Amount ({{ base_currency.symbol }})</label>
                    <input type="number" step="0.01" class="form-control bg-dark text-light" id="amount" name="amount" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="period" class="form-label">Budget Period</label>
                    <select class="form-select bg-dark text-light" id="period" name="period" required>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control bg-dark text-light" id="start_date" name="start_date" required>
                </div>
                <div class="col-md-8 mb-3">
                    <label for="category_id" class="form-label">Category</label>
                    <select class="form-select bg-dark text-light" id="category_id" name="category_id" required>
                        <option value="">Select a category</option>
                        {% for category in categories %}
                            {% if not category.parent_id %}
                                <!-- Parent category -->
                                <optgroup label="{{ category.name }}">
                                    <!-- Add the parent category itself -->
                                    <option value="{{ category.id }}" data-is-parent="true">
                                        {{ category.name }} (Overall)
                                    </option>
                                    
                                    <!-- Add subcategories -->
                                    {% for subcategory in category.subcategories %}
                                        <option value="{{ subcategory.id }}" data-parent-id="{{ category.id }}">
                                            — {{ subcategory.name }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="include_subcategories" name="include_subcategories" checked>
                        <label class="form-check-label" for="include_subcategories">Include subcategories in budget</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring" checked>
                        <label class="form-check-label" for="is_recurring">Recurring budget</label>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 text-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="toggleBudgetForm()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Budget</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Budget Modal -->
<div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBudgetForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_name" class="form-label">Budget Name (Optional)</label>
                            <input type="text" class="form-control bg-dark text-light" id="edit_name" name="name" placeholder="E.g., Monthly Groceries">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_amount" class="form-label">Budget Amount ({{ base_currency.symbol }})</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light" id="edit_amount" name="amount" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_period" class="form-label">Budget Period</label>
                            <select class="form-select bg-dark text-light" id="edit_period" name="period" required>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control bg-dark text-light" id="edit_start_date" name="start_date">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="edit_category_id" class="form-label">Category</label>
                            <select class="form-select bg-dark text-light" id="edit_category_id" name="category_id" required>
                                <option value="">Select a category</option>
                                {% for category in categories %}
                                    {% if not category.parent_id %}
                                        <!-- Parent category -->
                                        <optgroup label="{{ category.name }}">
                                            <!-- Add the parent category itself -->
                                            <option value="{{ category.id }}" data-is-parent="true">
                                                {{ category.name }} (Overall)
                                            </option>
                                            
                                            <!-- Add subcategories -->
                                            {% for subcategory in category.subcategories %}
                                                <option value="{{ subcategory.id }}" data-parent-id="{{ category.id }}">
                                                    — {{ subcategory.name }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit_include_subcategories" name="include_subcategories">
                                <label class="form-check-label" for="edit_include_subcategories">Include subcategories in budget</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit_is_recurring" name="is_recurring">
                                <label class="form-check-label" for="edit_is_recurring">Recurring budget</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Progress Information -->
                    <div class="mt-4 p-3 border border-secondary rounded">
                        <h6 class="mb-3">Current Budget Status</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1">Spent so far:</p>
                                <h5 id="edit_spent" class="text-info">{{ base_currency.symbol }}0.00</h5>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1">Remaining:</p>
                                <h5 id="edit_remaining" class="text-success">{{ base_currency.symbol }}0.00</h5>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1">Progress:</p>
                                <div class="progress mt-2" style="height: 10px;">
                                    <div id="edit_progress_bar" class="progress-bar bg-success" 
                                         role="progressbar" 
                                         style="width: 0%;" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100"></div>
                                </div>
                                <p class="mt-1 small" id="edit_percentage">0%</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    /* Modified slide panel styles with green accent colors */
.budget-slide-panel {
    position: fixed;
    top: 0;
    right: -500px;
    width: 500px;
    height: 100vh;
    background-color: #1e1e1e;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
    transition: right 0.3s ease-in-out;
    z-index: 1060;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.budget-slide-panel.active {
    right: 0;
    animation: slideInPanel 0.2s ease-out;
}

.slide-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.slide-panel-overlay.active {
    opacity: 1;
    visibility: visible;
}

.slide-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #2d2d2d;
    background-color: #1a2e22; /* Dark green header */
    position: sticky;
    top: 0;
    z-index: 1;
}

.slide-panel-content {
    flex: 1;
    overflow-y: auto;
}

/* Apply green styling to form elements */
.budget-slide-panel .form-control:focus,
.budget-slide-panel .form-select:focus,
#add-budget-slide-panel .form-control:focus,
#add-budget-slide-panel .form-select:focus,
.transaction-slide-panel .form-control:focus,
.transaction-slide-panel .form-select:focus {
    border-color: #15803d; /* Green focus */
    box-shadow: 0 0 0 0.25rem rgba(21, 128, 61, 0.25);
}

.budget-slide-panel .btn-primary,
#add-budget-slide-panel .btn-primary,
.transaction-slide-panel .btn-primary {
    background-color: #15803d; /* Green primary button */
    border-color: #15803d;
}

.budget-slide-panel .btn-primary:hover,
#add-budget-slide-panel .btn-primary:hover,
.transaction-slide-panel .btn-primary:hover {
    background-color: #166534; /* Darker green on hover */
    border-color: #166534;
}

/* Card styling with green accents */
.budget-slide-panel .card:hover,
#add-budget-slide-panel .card:hover,
.transaction-slide-panel .card:hover {
    border-color: rgba(21, 128, 61, 0.5); /* Green border on hover */
    box-shadow: 0 0 10px rgba(21, 128, 61, 0.1);
}

/* Animation for sliding in the panel */
@keyframes slideInPanel {
    from { transform: translateX(20px); opacity: 0.8; }
    to { transform: translateX(0); opacity: 1; }
}

/* Form element animations */
.budget-slide-panel .form-control,
.budget-slide-panel .form-select,
.budget-slide-panel .form-check,
.budget-slide-panel .btn,
#add-budget-slide-panel .form-control,
#add-budget-slide-panel .form-select,
#add-budget-slide-panel .form-check,
#add-budget-slide-panel .btn {
    animation: fadeInForm 0.3s ease forwards;
    animation-delay: 0.1s;
    opacity: 0;
}

@keyframes fadeInForm {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .budget-slide-panel {
        width: 100%;
        right: -100%;
    }
}
</style>    
<script>
     document.addEventListener('DOMContentLoaded', function() {
    // Initialize today's date for the start date field
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    if (startDateInput) {
        startDateInput.value = today;
    }
    
    // Add toggle for budget form
    const toggleButton = document.getElementById('toggleBudgetForm');
    if (toggleButton) {
        toggleButton.addEventListener('click', toggleBudgetForm);
    }
    
    // Initialize charts
    initializeDonutChart();
    initializeBarChart();
    
    // Make budget rows clickable
    setupBudgetTableInteraction();
    
    // Initialize reset button
    const resetButton = document.getElementById('reset-budget-selection');
    if (resetButton) {
        resetButton.addEventListener('click', resetBudgetSelection);
    }
    
    // Add hover effects to all cards
    addCardHoverEffects();
});
function editBudget(budgetId) {
    // Open the budget slide panel
    openBudgetSlidePanel(budgetId);
}

function openBudgetSlidePanel(budgetId) {
    // Create or get the slide panel if it already exists
    let slidePanel = document.getElementById('budget-slide-panel');
    
    if (!slidePanel) {
        // Create the panel
        slidePanel = document.createElement('div');
        slidePanel.id = 'budget-slide-panel';
        slidePanel.className = 'budget-slide-panel';
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'slide-panel-overlay';
        overlay.id = 'slide-panel-overlay';
        overlay.addEventListener('click', closeBudgetSlidePanel);
        
        // Add to DOM
        document.body.appendChild(overlay);
        document.body.appendChild(slidePanel);
    }
    
    // Show loading state
    slidePanel.innerHTML = `
        <div class="slide-panel-header">
            <h4 class="mb-0">
                <i class="fas fa-edit me-2" style="color: #0ea5e9;"></i>
                Edit Budget
            </h4>
            <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeBudgetSlidePanel()"></button>
        </div>
        <div class="slide-panel-content">
            <div class="d-flex justify-content-center align-items-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-3">Loading budget details...</span>
            </div>
        </div>
    `;
    
    // Show the panel and overlay
    document.getElementById('slide-panel-overlay').classList.add('active');
    slidePanel.classList.add('active');
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
    
    // Fetch budget data
    fetch(`/budgets/get/${budgetId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch budget details');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                populateBudgetSlidePanel(data.budget);
            } else {
                showSlidePanelError(data.message || 'Error fetching budget details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSlidePanelError('Failed to fetch budget details: ' + error.message);
        });
}

function closeBudgetSlidePanel() {
    // Get the panel and overlay
    const slidePanel = document.getElementById('budget-slide-panel');
    const overlay = document.getElementById('slide-panel-overlay');
    
    if (slidePanel) slidePanel.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
    
    // Re-enable body scrolling
    document.body.style.overflow = '';
}

function showSlidePanelError(message) {
    const slidePanel = document.getElementById('budget-slide-panel');
    if (!slidePanel) return;
    
    const contentDiv = slidePanel.querySelector('.slide-panel-content');
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-secondary" onclick="closeBudgetSlidePanel()">
                    Close
                </button>
            </div>
        `;
    }
}

function populateBudgetSlidePanel(budget) {
    const slidePanel = document.getElementById('budget-slide-panel');
    if (!slidePanel) return;
    
    const contentDiv = slidePanel.querySelector('.slide-panel-content');
    if (!contentDiv) return;
    
    // Create form HTML that matches your existing edit form styling
    contentDiv.innerHTML = `
        <form id="slide-panel-edit-form" action="/budgets/edit/${budget.id}" method="POST">
            <div class="p-4">
                <!-- Budget Info Summary -->
                <div class="card bg-dark mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge me-2" style="background-color: ${budget.category_color || '#6c757d'};">
                                <i class="fas ${budget.category_icon || 'fa-tag'}"></i>
                            </span>
                            <h5 class="mb-0">${budget.category_name || 'Budget'}</h5>
                        </div>
                        
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar 
                                ${budget.status === 'over' ? 'bg-danger' : 
                                 budget.status === 'approaching' ? 'bg-warning' : 'bg-success'}" 
                                role="progressbar" 
                                style="width: ${budget.percentage}%;" 
                                aria-valuenow="${budget.percentage}" 
                                aria-valuemin="0" 
                                aria-valuemax="100"></div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-4 text-center">
                                <small class="d-block text-muted">Budget</small>
                                <div class="fw-bold">${formatCurrency(budget.amount)}</div>
                            </div>
                            <div class="col-4 text-center">
                                <small class="d-block text-muted">Spent</small>
                                <div class="fw-bold">${formatCurrency(budget.spent)}</div>
                            </div>
                            <div class="col-4 text-center">
                                <small class="d-block text-muted">Remaining</small>
                                <div class="fw-bold ${budget.remaining < 0 ? 'text-danger' : 'text-success'}">
                                    ${formatCurrency(Math.abs(budget.remaining))}
                                    ${budget.remaining < 0 ? '<i class="fas fa-arrow-down"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Fields -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="slide_edit_name" class="form-label">Budget Name (Optional)</label>
                        <input type="text" class="form-control bg-dark text-light" id="slide_edit_name" name="name" 
                               value="${budget.name || ''}" placeholder="E.g., Monthly Groceries">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="slide_edit_amount" class="form-label">Budget Amount</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">$</span>
                            <input type="number" step="0.01" class="form-control bg-dark text-light" id="slide_edit_amount" 
                                   name="amount" value="${budget.amount}" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="slide_edit_period" class="form-label">Budget Period</label>
                        <select class="form-select bg-dark text-light" id="slide_edit_period" name="period" required>
                            <option value="weekly" ${budget.period === 'weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="monthly" ${budget.period === 'monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="yearly" ${budget.period === 'yearly' ? 'selected' : ''}>Yearly</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="slide_edit_start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control bg-dark text-light" id="slide_edit_start_date" 
                               name="start_date" value="${budget.start_date}">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="slide_edit_category_id" class="form-label">Category</label>
                    <select class="form-select bg-dark text-light" id="slide_edit_category_id" name="category_id" required>
                        <option value="">Select a category</option>
                        <!-- Category options will be populated via JavaScript -->
                    </select>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="slide_edit_include_subcategories" 
                                   name="include_subcategories" ${budget.include_subcategories ? 'checked' : ''}>
                            <label class="form-check-label" for="slide_edit_include_subcategories">
                                Include subcategories in budget
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="slide_edit_is_recurring" 
                                   name="is_recurring" ${budget.is_recurring ? 'checked' : ''}>
                            <label class="form-check-label" for="slide_edit_is_recurring">
                                Recurring budget
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="closeBudgetSlidePanel()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        </form>
    `;
    
    // Populate category select dropdown
    populateCategoryOptions('slide_edit_category_id', budget.category_id);
    
    // Add form submit handler
    const form = document.getElementById('slide-panel-edit-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update budget');
            return response.text();
        })
        .then(() => {
            // Show success notification
            showToast('Budget updated successfully!', 'success');
            
            // Close the panel
            closeBudgetSlidePanel();
            
            // Refresh the page after a delay to show updated data
            setTimeout(() => window.location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating budget: ' + error.message, 'error');
        });
    });
}
function editTransaction(transactionId) {
    // Call our slide-in panel function
    openTransactionSlidePanel(transactionId);
}

function openTransactionSlidePanel(transactionId) {
    // Create or get the slide panel if it already exists
    let slidePanel = document.getElementById('transaction-slide-panel');
    
    if (!slidePanel) {
        // Create the panel
        slidePanel = document.createElement('div');
        slidePanel.id = 'transaction-slide-panel';
        slidePanel.className = 'budget-slide-panel transaction-slide-panel'; // Reuse the same styling
        
        // Create overlay if it doesn't exist
        let overlay = document.getElementById('slide-panel-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'slide-panel-overlay';
            overlay.id = 'slide-panel-overlay';
            overlay.addEventListener('click', closeTransactionSlidePanel);
            document.body.appendChild(overlay);
        }
        
        // Add to DOM
        document.body.appendChild(slidePanel);
    }
    
    // Show loading state
    slidePanel.innerHTML = `
        <div class="slide-panel-header">
            <h4 class="mb-0">
                <i class="fas fa-receipt me-2" style="color: #0ea5e9;"></i>
                Edit Transaction
            </h4>
            <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeTransactionSlidePanel()"></button>
        </div>
        <div class="slide-panel-content">
            <div class="d-flex justify-content-center align-items-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-3">Loading transaction details...</span>
            </div>
        </div>
    `;
    
    // Show the panel and overlay
    document.getElementById('slide-panel-overlay').classList.add('active');
    slidePanel.classList.add('active');
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
    
    // Fetch transaction data
    fetch(`/get_expense/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateTransactionSlidePanel(data.expense, transactionId);
            } else {
                showTransactionSlidePanelError(data.message || 'Error fetching transaction details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showTransactionSlidePanelError('Failed to fetch transaction details: ' + error.message);
        });
}

function closeTransactionSlidePanel() {
    // Get the panel and overlay
    const slidePanel = document.getElementById('transaction-slide-panel');
    const overlay = document.getElementById('slide-panel-overlay');
    
    if (slidePanel) slidePanel.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
    
    // Re-enable body scrolling
    document.body.style.overflow = '';
}

function showTransactionSlidePanelError(message) {
    const slidePanel = document.getElementById('transaction-slide-panel');
    if (!slidePanel) return;
    
    const contentDiv = slidePanel.querySelector('.slide-panel-content');
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-secondary" onclick="closeTransactionSlidePanel()">
                    Close
                </button>
            </div>
        `;
    }
}


function populateTransactionSlidePanel(transaction, transactionId) {
    const slidePanel = document.getElementById('transaction-slide-panel');
    if (!slidePanel) return;
    
    const contentDiv = slidePanel.querySelector('.slide-panel-content');
    if (!contentDiv) return;
    
    // Format the date for the input field (YYYY-MM-DD)
    const expenseDate = new Date(transaction.date);
    const formattedDate = expenseDate.toISOString().split('T')[0];
    
    // Get the current budget context
    const budgetName = window.currentBudgetName || 'Budget';
    
    // Create form HTML with simplified fields (no split options)
    contentDiv.innerHTML = `
        <form id="slide-panel-transaction-form" action="/update_expense/${transactionId}" method="POST">
            <div class="p-4">
                <!-- Transaction Info Summary -->
                <div class="card bg-dark mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-info text-dark me-2">
                                Budget: ${budgetName}
                            </span>
                            <h5 class="mb-0">
                                Transaction #${transactionId}
                            </h5>
                        </div>
                        
                        <div class="mt-2">
                            <span class="badge bg-secondary">
                                <i class="fas fa-clock me-1"></i>
                                ${formattedDate}
                            </span>
                            <span class="badge bg-secondary ms-2">
                                <i class="fas fa-wallet me-1"></i>
                                ${transaction.card_used || 'No payment method'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Form Fields -->
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="slide_transaction_description" class="form-label">Description</label>
                        <input type="text" class="form-control bg-dark text-light" 
                               id="slide_transaction_description" name="description" 
                               value="${transaction.description}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="slide_transaction_amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">$</span>
                            <input type="number" step="0.01" class="form-control bg-dark text-light" 
                                   id="slide_transaction_amount" name="amount" 
                                   value="${transaction.amount}" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="slide_transaction_date" class="form-label">Date</label>
                        <input type="date" class="form-control bg-dark text-light" 
                               id="slide_transaction_date" name="date" 
                               value="${formattedDate}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="slide_transaction_category" class="form-label">Category</label>
                        <select class="form-select bg-dark text-light" 
                                id="slide_transaction_category" name="category_id">
                            <option value="">Select category</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    
                </div>
                
                <!-- Hidden fields to preserve data -->
                <input type="hidden" name="paid_by" value="${transaction.paid_by}">
                <input type="hidden" name="personal_expense" value="on">
                <input type="hidden" name="split_method" value="equal">
                
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteTransaction(${transactionId})">
                        <i class="fas fa-trash-alt me-1"></i> Delete
                    </button>
                    
                    <div>
                        <button type="button" class="btn btn-secondary me-2" onclick="closeTransactionSlidePanel()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </form>
    `;
    
    // Populate category dropdown
    populateTransactionCategoryOptions('slide_transaction_category', transaction.category_id);
    // Add form submit handler
    const form = document.getElementById('slide-panel-transaction-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update transaction');
            return response.text();
        })
        .then(() => {
            // Show success notification
            showToast('Transaction updated successfully!', 'success');
            
            // Close the panel
            closeTransactionSlidePanel();
            
            // Refresh the transactions in the current budget view
            const currentBudgetId = getCurrentSelectedBudgetId();
            if (currentBudgetId) {
                loadBudgetTransactions(currentBudgetId);
            } else {
                // Fallback to full page reload if we can't determine the current budget
                setTimeout(() => window.location.reload(), 500);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating transaction: ' + error.message, 'error');
        });
    });
}

// Helper function to populate split with options
function populateSplitWithOptions(selectId, selectedUserIds) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Add users from the DOM - assuming there's a list of users elsewhere in the page
    // You might need to adjust this to use your actual user data source
    fetch('/api/users')
        .then(response => response.json())
        .then(users => {
            // Clear existing options
            select.innerHTML = '';
            
            // Add user options
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                option.selected = selectedUserIds.includes(user.id);
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching users:', error);
            
            // Fallback: try to get users from the page
            const usersSelect = document.querySelector('select[name="split_with"]');
            if (usersSelect) {
                // Clone options
                select.innerHTML = usersSelect.innerHTML;
                
                // Set selected values
                selectedUserIds.forEach(userId => {
                    const option = select.querySelector(`option[value="${userId}"]`);
                    if (option) option.selected = true;
                });
            }
        });
}
function confirmDeleteTransaction(transactionId) {
    if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        fetch(`/delete_expense/${transactionId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete transaction');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success notification
                showToast('Transaction deleted successfully!', 'success');
                
                // Close the panel
                closeTransactionSlidePanel();
                
                // Refresh transactions in the current budget view
                const currentBudgetId = getCurrentSelectedBudgetId();
                if (currentBudgetId) {
                    loadBudgetTransactions(currentBudgetId);
                } else {
                    // Fallback to full page reload
                    setTimeout(() => window.location.reload(), 500);
                }
            } else {
                throw new Error(data.message || 'Failed to delete transaction');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error deleting transaction: ' + error.message, 'error');
        });
    }
}

// Helper function to populate category options
function populateCategoryOptions(selectId, selectedCategoryId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Get categories from the existing page dropdown
    const existingCategorySelect = document.getElementById('edit_category_id');
    if (existingCategorySelect) {
        // Clone options from existing select
        select.innerHTML = existingCategorySelect.innerHTML;
        
        // Set selected option
        if (selectedCategoryId) {
            const option = select.querySelector(`option[value="${selectedCategoryId}"]`);
            if (option) option.selected = true;
        }
    }
}

// Helper function for transaction categories
function populateTransactionCategoryOptions(selectId, selectedCategoryId) {
    populateCategoryOptions(selectId, selectedCategoryId);
}

// Helper function to show toast notifications
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '5';
        document.body.appendChild(toastContainer);
    }
    
    // Create unique ID for this toast
    const toastId = 'toast-' + Date.now();
    
    // Determine toast color based on type
    let bgClass = 'bg-primary';
    if (type === 'success') bgClass = 'bg-success';
    if (type === 'error') bgClass = 'bg-danger';
    if (type === 'warning') bgClass = 'bg-warning text-dark';
    
    // Create toast HTML
    const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">Budget App</strong>
                <small>Just now</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // Add toast to container
    toastContainer.innerHTML += toastHtml;
    
    // Initialize and show the toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Helper function to get the currently selected budget ID
function getCurrentSelectedBudgetId() {
    const selectedRow = document.querySelector('.budget-row.selected-budget');
    return selectedRow ? selectedRow.getAttribute('data-budget-id') : null;
}

// Add hover effects to all cards
function addCardHoverEffects() {
    const cards = document.querySelectorAll('.card');
    
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.2)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });
}

// Format currency with user's locale
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

// Format a date string from ISO format to readable format
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Toggle transaction details visibility
function toggleTransactionDetails(detailsId, button) {
    const detailsRow = document.getElementById(detailsId);
    if (!detailsRow) return;
    
    if (detailsRow.style.display === 'none') {
        // Show details
        detailsRow.style.display = 'table-row';
        button.innerHTML = '<i class="fas fa-chevron-down"></i>';
        
        // Find the associated transaction row and highlight it
        const transactionRow = detailsRow.previousElementSibling;
        if (transactionRow) {
            transactionRow.classList.add('bg-dark');
        }
    } else {
        // Hide details
        detailsRow.style.display = 'none';
        button.innerHTML = '<i class="fas fa-chevron-right"></i>';
        
        // Find the associated transaction row and remove highlight
        const transactionRow = detailsRow.previousElementSibling;
        if (transactionRow) {
            transactionRow.classList.remove('bg-dark');
        }
    }
}

// Delete budget functionality
function deleteBudget(budgetId) {
    if (confirm('Are you sure you want to delete this budget? This action cannot be undone.')) {
        // Create a form dynamically to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/budgets/delete/${budgetId}`;
        document.body.appendChild(form);
        form.submit();
    }
}
// Toggle budget form visibility
function toggleBudgetForm() {
    openAddBudgetPanel();
    
}
function openAddBudgetPanel() {
    // Create or get the slide panel if it already exists
    let slidePanel = document.getElementById('add-budget-slide-panel');
    
    if (!slidePanel) {
        // Create the panel
        slidePanel = document.createElement('div');
        slidePanel.id = 'add-budget-slide-panel';
        slidePanel.className = 'budget-slide-panel';
        
        // Create overlay if it doesn't exist
        let overlay = document.getElementById('slide-panel-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'slide-panel-overlay';
            overlay.id = 'slide-panel-overlay';
            overlay.addEventListener('click', closeAddBudgetPanel);
            document.body.appendChild(overlay);
        }
        
        // Add to DOM
        document.body.appendChild(slidePanel);
    }
    
    // Get today's date for the form
    const today = new Date().toISOString().split('T')[0];
    
    // Show the panel with form
    slidePanel.innerHTML = `
        <div class="slide-panel-header">
            <h4 class="mb-0">
                <i class="fas fa-plus me-2" style="color: #15803d;"></i>
                Add New Budget
            </h4>
            <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeAddBudgetPanel()"></button>
        </div>
        <div class="slide-panel-content">
            <form id="add-budget-form" action="/budgets/add" method="POST">
                <div class="p-4">
                    <!-- Form Fields -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="slide_add_name" class="form-label">Budget Name (Optional)</label>
                            <input type="text" class="form-control bg-dark text-light" id="slide_add_name" name="name" 
                                   placeholder="E.g., Monthly Groceries">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="slide_add_amount" class="form-label">Budget Amount</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                <input type="number" step="0.01" class="form-control bg-dark text-light" id="slide_add_amount" 
                                       name="amount" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="slide_add_period" class="form-label">Budget Period</label>
                            <select class="form-select bg-dark text-light" id="slide_add_period" name="period" required>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="slide_add_start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control bg-dark text-light" id="slide_add_start_date" 
                                   name="start_date" value="${today}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="slide_add_category_id" class="form-label">Category</label>
                        <select class="form-select bg-dark text-light" id="slide_add_category_id" name="category_id" required>
                            <option value="">Select a category</option>
                            <!-- Category options will be populated via JavaScript -->
                        </select>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="slide_add_include_subcategories" 
                                       name="include_subcategories" checked>
                                <label class="form-check-label" for="slide_add_include_subcategories">
                                    Include subcategories in budget
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="slide_add_is_recurring" 
                                       name="is_recurring" checked>
                                <label class="form-check-label" for="slide_add_is_recurring">
                                    Recurring budget
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="closeAddBudgetPanel()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Add Budget
                        </button>
                    </div>
                </div>
            </form>
        </div>
    `;
    
    // Show the panel and overlay
    document.getElementById('slide-panel-overlay').classList.add('active');
    slidePanel.classList.add('active');
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
    
    // Populate category select dropdown
    populateCategoryOptions('slide_add_category_id');
    
    // Add form submit handler
    const form = document.getElementById('add-budget-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to add budget');
            return response.text();
        })
        .then(() => {
            // Show success notification
            showToast('Budget added successfully!', 'success');
            
            // Close the panel
            closeAddBudgetPanel();
            
            // Refresh the page after a delay to show updated data
            setTimeout(() => window.location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error adding budget: ' + error.message, 'error');
        });
    });
}

function closeAddBudgetPanel() {
    // Get the panel and overlay
    const slidePanel = document.getElementById('add-budget-slide-panel');
    const overlay = document.getElementById('slide-panel-overlay');
    
    if (slidePanel) slidePanel.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
    
    // Re-enable body scrolling
    document.body.style.overflow = '';
}
// Load transactions for a specific budget
function loadBudgetTransactions(budgetId) {
    const transactionsContainer = document.getElementById('budget-transactions-container');
    if (!transactionsContainer) return;
    
    // Show loading state
    transactionsContainer.innerHTML = `
        <div class="d-flex justify-content-center py-4">
            <div class="spinner-border text-secondary" role="status">
                <span class="visually-hidden">Loading transactions...</span>
            </div>
            <span class="ms-2">Loading transactions...</span>
        </div>
    `;
    
    // Use the existing budget transactions endpoint
    fetch(`/budgets/transactions/${budgetId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load transactions');
            }
            return response.json();
        })
        .then(data => {
            displayBudgetTransactions(data.transactions || [], transactionsContainer);
            
            // Update transaction count badge
            const countBadge = document.getElementById('transaction-count-badge');
            if (countBadge) {
                countBadge.textContent = `${data.transactions.length} transactions`;
            }
            
            // Store budget name for reference (properly formatted)
            window.currentBudgetName = data.budget_name || 'Budget';
            window.currentBudgetId = budgetId;
        })
        .catch(error => {
            console.error('Error fetching transactions:', error);
            transactionsContainer.innerHTML = `
                <div class="alert alert-warning text-center m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unable to load transactions. Please try again later.
                </div>
            `;
        });
}

// Display fetched transactions in the container
function displayBudgetTransactions(transactions, container) {
    // If no transactions
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">No transactions found for this budget.</p>
            </div>
        `;
        return;
    }
    
    // Create transactions table
    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 20px;"></th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Add transaction rows
    transactions.forEach((transaction, index) => {
        const amountClass = transaction.amount < 0 ? 'text-danger' : 'text-success';
        const amountPrefix = transaction.amount < 0 ? '-' : '';
        const formattedAmount = `${amountPrefix}${formatCurrency(Math.abs(transaction.amount))}`;
        
        // Generate unique IDs for this transaction
        const transId = `trans-${transaction.id}`;
        const detailsId = `details-${transId}`;
        
        // Main transaction row
        tableHTML += `
            <tr class="transaction-row" data-transaction-id="${transaction.id}">
                <td>
                    <button class="btn btn-sm btn-link p-0 expand-button" onclick="toggleTransactionDetails('${detailsId}', this)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </td>
                <td>${formatDate(transaction.date)}</td>
                <td>${transaction.description}</td>
                <td class="${amountClass}">${formattedAmount}</td>
                <td>
                    <span class="badge" style="background-color: ${transaction.category_color || '#6c757d'};">
                        <i class="fas ${transaction.category_icon || 'fa-tag'}"></i>
                        ${transaction.category_name || 'Uncategorized'}
                    </span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="editTransaction(${transaction.id})">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </td>
            </tr>
            
            <!-- Expandable details row (hidden by default) -->
            <tr id="${detailsId}" class="transaction-details" style="display: none;">
                <td colspan="6" class="p-0">
                    <div class="card bg-dark border-secondary mb-0">
                        <div class="card-body py-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-2">Transaction Details</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>ID:</strong> ${transaction.id}</li>
                                        <li><strong>Payment Method:</strong> ${transaction.payment_method || transaction.card_used || 'Not specified'}</li>
                                        <li><strong>Transaction Type:</strong> ${transaction.transaction_type || 'Expense'}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-2">Budget Information</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Budget:</strong> ${transaction.category_name || 'Uncategorized'}</li>
                                        <li><strong>Tags:</strong> ${(transaction.tags || []).join(', ') || 'No tags'}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <form action="/delete_expense/${transaction.id}" method="POST" class="d-inline" 
                                      onsubmit="return confirm('Are you sure you want to delete this transaction?')">
                                    <button type="submit" class="btn btn-sm btn-danger me-2">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </button>
                                </form>
                                <button type="button" class="btn btn-sm btn-primary" onclick="editTransaction(${transaction.id})">
                                    <i class="fas fa-pencil-alt me-1"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHTML;
}
// Initialize the donut chart using data from the DOM
function initializeDonutChart() {
    const chartContainer = document.getElementById('budget-donut-container');
    if (!chartContainer) return;
    
    // Clear container
    chartContainer.innerHTML = '';
    
    // Create canvas
    const canvas = document.createElement('canvas');
    canvas.id = 'budget-donut-chart';
    chartContainer.appendChild(canvas);
    
    // Get all budget rows to extract data and colors
    const budgetRows = document.querySelectorAll('.budget-row');
    
    // Prepare data for the chart
    const budgetData = [];
    const budgetColors = [];
    const budgetLabels = [];
    let totalMonthlyBudget = 0;
    let totalMonthlySpent = 0;
    
    // Process each budget
    budgetRows.forEach(row => {
        // Only process monthly budgets
        const periodElement = row.querySelector('td:nth-child(2) small');
        if (!periodElement || !periodElement.textContent.includes('Monthly')) {
            return;
        }
        
        // Get budget amount
        const budgetCell = row.querySelector('td:nth-child(2)');
        if (!budgetCell) return;
        
        const budgetText = budgetCell.textContent;
        const budgetAmount = parseFloat(budgetText.replace(/[^0-9.-]+/g, ""));
        
        if (isNaN(budgetAmount)) return;
        
        // Get budget name
        const nameElement = row.querySelector('.budget-name');
        const budgetName = nameElement ? nameElement.textContent : 'Unknown';
        
        // Get budget color
        const badgeElement = row.querySelector('.badge');
        const budgetColor = badgeElement ? badgeElement.style.backgroundColor : '#6c757d';
        
        // Get spent amount
        const progressElement = row.querySelector('td:nth-child(3) small');
        let spentAmount = 0;
        
        if (progressElement) {
            const matches = progressElement.textContent.match(/\((.*?)\)/);
            if (matches && matches[1]) {
                spentAmount = parseFloat(matches[1].replace(/[^0-9.-]+/g, ""));
            }
        }
        
        // Add to totals
        totalMonthlyBudget += budgetAmount;
        totalMonthlySpent += spentAmount;
        
        // Add to chart data
        budgetData.push(budgetAmount);
        budgetColors.push(budgetColor);
        budgetLabels.push(budgetName);
    });
    
    // If no budgets found, show empty chart message
    if (budgetData.length === 0) {
        chartContainer.innerHTML = '<p class="text-center text-muted my-5">No monthly budgets available</p>';
        return;
    }
    
    // Create chart
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: budgetLabels,
            datasets: [{
                data: budgetData,
                backgroundColor: budgetColors,
                borderWidth: 0,
                cutout: '70%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // Hide legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const percentage = Math.round((value / totalMonthlyBudget) * 100);
                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'donutText',
            beforeDraw: function(chart) {
                const width = chart.width;
                const height = chart.height;
                const ctx = chart.ctx;
                
                ctx.restore();
                ctx.save();
                ctx.textAlign = 'center';
                
                // Percentage in the middle
                const percentage = Math.round((totalMonthlySpent / totalMonthlyBudget) * 100) || 0;
                ctx.font = 'bold 28px Arial';
                ctx.fillStyle = 'white';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${percentage}%`, width / 2, height / 2 - 10);
                
                // "used" text below
                ctx.font = '12px Arial';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fillText('used', width / 2, height / 2 + 15);
                
                ctx.restore();
            }
        }]
    });
    
    // Update budget summary values
    updateBudgetSummary(totalMonthlyBudget, totalMonthlySpent);
}

// Update the budget summary display
function updateBudgetSummary(totalBudget, totalSpent) {
    const budgetElement = document.getElementById('total-month-budget');
    const spentElement = document.getElementById('total-month-spent');
    const remainingElement = document.getElementById('total-month-remaining');
    const remainingAmount = totalBudget - totalSpent;
    
    if (budgetElement) {
        budgetElement.textContent = formatCurrency(totalBudget);
    }
    if (spentElement) {
        spentElement.textContent = formatCurrency(totalSpent);
    }
    if (remainingElement) {
        remainingElement.textContent = formatCurrency(Math.abs(remainingAmount));
        
        // Add visual indicators based on remaining amount
        if (remainingAmount < 0) {
            remainingElement.classList.add('text-danger');
            remainingElement.classList.remove('text-success');
            if (!remainingElement.querySelector('.fa-arrow-down')) {
                remainingElement.innerHTML += ' <i class="fas fa-arrow-down text-danger"></i>';
            }
        } else {
            remainingElement.classList.remove('text-danger');
            remainingElement.classList.add('text-success');
            // Remove any existing arrow icons
            const arrow = remainingElement.querySelector('.fa-arrow-down');
            if (arrow) {
                arrow.remove();
            }
        }
    }
}

// Initialize bar chart for budget trends
function initializeBarChart(selectedBudgetId = null) {
    const chartContainer = document.getElementById('budget-chart-container');
    if (!chartContainer) return;
    
    // Show loading spinner
    chartContainer.innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-secondary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    // Create the URL for the endpoint
    let url = '/budgets/trends-data';
    if (selectedBudgetId) {
        url += `?budget_id=${selectedBudgetId}`;
    }
    
    // Get chart data from server
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load budget trend data');
            }
            return response.json();
        })
        .then(data => {
            createBudgetChart(chartContainer, data);
        })
        .catch(error => {
            console.error('Error fetching budget trends:', error);
            chartContainer.innerHTML = `
                <div class="alert alert-warning text-center m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unable to load budget trends data. Please try again later.
                </div>
            `;
        });
}

// Create budget chart from server data
function createBudgetChart(container, data) {
    // Clear container
    container.innerHTML = '';
    
    // Check if we have data
    if (!data || !data.labels || data.labels.length === 0) {
        container.innerHTML = '<p class="text-center text-muted my-5">No budget trend data available</p>';
        return;
    }
    
    // Create canvas for chart
    const canvas = document.createElement('canvas');
    canvas.id = 'budget-bar-chart';
    container.appendChild(canvas);
    
    // Create chart
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Actual Spending',
                    data: data.actual,
                    backgroundColor: data.colors || data.actual.map(value => {
                        // Calculate color based on whether spending exceeds budget
                        const index = data.actual.indexOf(value);
                        return value > data.budget[index] ? '#ef4444' : '#22c55e';
                    }),
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    barPercentage: 0.6
                },
                {
                    label: 'Budget',
                    data: data.budget,
                    type: 'line',
                    fill: false,
                    borderColor: '#ffffff',
                    borderDash: [5, 5],
                    pointBackgroundColor: '#ffffff',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += formatCurrency(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// Setup budget table interaction
function setupBudgetTableInteraction() {
    const budgetRows = document.querySelectorAll('.budget-row');
    
    budgetRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger when clicking action buttons
            if (e.target.closest('.dropdown') || e.target.tagName === 'INPUT') {
                return;
            }
            
            // Get budget ID and name
            const budgetId = this.getAttribute('data-budget-id');
            const nameElement = this.querySelector('.budget-name');
            const budgetName = nameElement ? nameElement.textContent : 'Selected Budget';
            
            // Mark this row as selected
            selectBudgetRow(this, budgetId, budgetName);
            
            // Load transactions for this budget
            loadBudgetTransactions(budgetId);
        });
    });
}

// Select a budget row and update related elements
function selectBudgetRow(row, budgetId, budgetName) {
    // Remove selection from all rows
    const allRows = document.querySelectorAll('.budget-row');
    allRows.forEach(r => r.classList.remove('selected-budget'));
    
    // Add selection to this row
    row.classList.add('selected-budget');
    
    // Update selection info
    const selectionElement = document.getElementById('selected-budget-name');
    const resetButton = document.getElementById('reset-budget-selection');
    
    if (selectionElement) {
        selectionElement.textContent = budgetName;
    }
    
    if (resetButton) {
        resetButton.style.display = 'inline-block';
    }
    
    // Update bar chart for selected budget
    initializeBarChart(budgetId);
}

// Reset budget selection
function resetBudgetSelection() {
    // Remove selection from all rows
    const allRows = document.querySelectorAll('.budget-row');
    allRows.forEach(r => r.classList.remove('selected-budget'));
    
    // Reset selection info
    const selectionElement = document.getElementById('selected-budget-name');
    const resetButton = document.getElementById('reset-budget-selection');
    
    if (selectionElement) {
        selectionElement.textContent = 'All Budgets';
    }
    
    if (resetButton) {
        resetButton.style.display = 'none';
    }
    
    // Reset charts to show all budgets
    initializeBarChart();
    
    // Clear transactions view
    const transactionsContainer = document.getElementById('budget-transactions-container');
    if (transactionsContainer) {
        transactionsContainer.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">Select a budget to view related transactions.</p>
            </div>
        `;
    }
    
    // Reset transaction count
    const countBadge = document.getElementById('transaction-count-badge');
    if (countBadge) {
        countBadge.textContent = '0 transactions';
    }
}

</script>
{% endblock %}
