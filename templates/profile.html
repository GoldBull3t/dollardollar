{% extends "base.html" %}

    <!-- dev-signature: 29a41de6a866d56c36aba5159f45257c -->
{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2>Meu perfil</h2>
        </div>
    </div>

    <div class="row">
        <!-- User Information Card -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header text-center">
                    <h5 class="mb-0">Informações do utilizador</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem; background-color: {{ user_color }};">
                            {{ current_user.name[0] | upper }}
                        </div>
                        <h4>{{ current_user.name }}</h4>
                        <p class="text-muted">{{ current_user.id }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted">Conta criada</label>
                        <p>{{ account_created }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted">Role</label>
                        <p>{% if current_user.is_admin %}<span class="badge bg-warning">Administrador</span>{% else %}<span class="badge bg-secondary">Utilizador</span>{% endif %}</p>
                    </div>
                    
                    <div class="d-grid">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>Terminar sessão
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Settings Column -->
        <div class="col-md-8">
            <!-- Change Color Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Minha cor</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_color') }}" method="POST">
                        <div class="mb-3">
                            <label for="user_color" class="form-label">Cor pessoal</label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color bg-dark" id="user_color" name="user_color" value="{{ user_color }}">
                                <input type="text" class="form-control bg-dark text-light" id="colorHex" value="{{ user_color }}" readonly>
                                <button type="submit" class="btn btn-primary">Save Color</button>
                            </div>
                            <div class="form-text text-muted mt-2">
                                Esta cor será utilizada para o identificar em actividades de grupo.
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Change Password Card - Only show for non-OIDC users -->
            {% if not (current_user.oidc_id and oidc_enabled) %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Alterar a palavra-passe</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('change_password') }}" method="POST">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Palavra-passe atual</label>
                            <input type="password" class="form-control bg-dark text-light" id="current_password" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new_password" class="form-label">Nova palavra-passe</label>
                            <input type="password" class="form-control bg-dark text-light" id="new_password" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirmar a nova palavra-passe</label>
                            <input type="password" class="form-control bg-dark text-light" id="confirm_password" name="confirm_password" required>
                            <div id="password-match-feedback" class="form-text" style="display: none;"></div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="password-submit-btn">Alterar a palavra-passe</button>
                        </div>
                    </form>
                </div>
            </div>
            {% elif current_user.oidc_id and oidc_enabled %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Informações de autenticação</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                         A sua conta utiliza a autenticação SSO. Para alterar a sua palavra-passe, actualize as suas credenciais no fornecedor de identificação.
                    </div>
                    {% if current_user.oidc_provider %}
                    <p class="text-muted mt-3">
                        <strong>Fornecedor de identidade:</strong> {{ current_user.oidc_provider }}
                    </p>
                    {% endif %}
                    {% if current_user.last_login %}
                    <p class="text-muted">
                        <strong>Último acesso:</strong> {{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            <!-- Timezone Preferences Card -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Preferências de fuso horário</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('update_timezone') }}" method="POST">
            <div class="mb-3">
                <label for="timezone" class="form-label">Selecione o seu fuso horário</label>
                <select class="form-select bg-dark text-light" name="timezone" id="timezone" required>
                    {% set current_timezone = current_user.timezone or 'UTC' %}
                    {% set timezone_groups = {
                        'North America': [
                            'America/New_York', 'America/Chicago', 
                            'America/Denver', 'America/Los_Angeles', 
                            'America/Anchorage', 'Pacific/Honolulu'
                        ],
                        'South America': [
                            'America/Sao_Paulo', 'America/Buenos_Aires', 
                            'America/Lima', 'America/Bogota'
                        ],
                        'Europe': [
                            'Europe/London', 'Europe/Paris', 
                            'Europe/Berlin', 'Europe/Moscow', 
                            'Europe/Rome', 'Europe/Madrid'
                        ],
                        'Asia': [
                            'Asia/Tokyo', 'Asia/Shanghai', 
                            'Asia/Dubai', 'Asia/Singapore', 
                            'Asia/Seoul', 'Asia/Kolkata', 
                            'Asia/Jerusalem'
                        ],
                        'Australia/Oceania': [
                            'Australia/Sydney', 'Australia/Melbourne', 
                            'Pacific/Auckland', 'Pacific/Fiji'
                        ],
                        'Africa': [
                            'Africa/Cairo', 'Africa/Johannesburg', 
                            'Africa/Lagos', 'Africa/Nairobi'
                        ]
                    } %}
                    
                    <option value="UTC" {% if current_timezone == 'UTC' %}selected{% endif %}>
                        UTC - Universal Coordinated Time
                    </option>
                    
                    {% for region, timezones in timezone_groups.items() %}
                    <optgroup label="{{ region }}">
                        {% for tz in timezones %}
                        <option value="{{ tz }}" {% if current_timezone == tz %}selected{% endif %}>
                            {{ tz.replace('_', ' ') }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
                <div class="form-text text-muted mt-2">
                    O seu fuso horário local ajuda-nos a apresentar datas e horas com precisão.
                </div>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Guardar fuso horário</button>
            </div>
        </form>
    </div>
</div>
            <!-- Default Currency Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Moeda padrão</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('set_default_currency') }}" method="POST">
                        <div class="mb-3">
                            <label for="default_currency" class="form-label">Selecionar a sua moeda padrão</label>
                            <select class="form-select bg-dark text-light" name="default_currency" id="default_currency" required>
                                {% for currency in currencies %}
                                    <option value="{{ currency.code }}" {% if current_user.default_currency_code == currency.code %}selected{% endif %}>
                                        {{ currency.code }} - {{ currency.name }} ({{ currency.symbol }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text text-muted mt-2">
                                Esta moeda será pré-selecionada ao criar novas despesas.
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Guardar moeda padrão</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Email Notification Preferences Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Notificações por e-mail</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_notification_preferences') }}" method="POST">
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="monthly_report_enabled" name="monthly_report_enabled" 
                                {% if current_user.monthly_report_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="monthly_report_enabled">
                                Enviar relatórios mensais de despesas
                            </label>
                            <div class="form-text text-muted mt-1">
                                Receba um e-mail no início de cada mês com um resumo das suas despesas, estado do orçamento e saldos.
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Guardar preferências de notificação</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle color picker change
    const colorPicker = document.getElementById('user_color');
    const colorHex = document.getElementById('colorHex');
    
    if (colorPicker && colorHex) {
        colorPicker.addEventListener('input', function() {
            colorHex.value = this.value;
            
            // Update user avatar preview color in real-time
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar) {
                userAvatar.style.backgroundColor = this.value;
            }
        });
    }
    
    // Password confirmation validation
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const feedbackElement = document.getElementById('password-match-feedback');
    const submitButton = document.getElementById('password-submit-btn');
    
    function validatePasswords() {
        if (confirmPassword.value && confirmPassword.value !== newPassword.value) {
            feedbackElement.textContent = "Passwords do not match";
            feedbackElement.className = "form-text text-danger";
            feedbackElement.style.display = "block";
            submitButton.disabled = true;
            return false;
        } else if (confirmPassword.value) {
            feedbackElement.textContent = "Passwords match";
            feedbackElement.className = "form-text text-success";
            feedbackElement.style.display = "block";
            submitButton.disabled = false;
            return true;
        } else {
            feedbackElement.style.display = "none";
            submitButton.disabled = false;
            return true;
        }
    }
    
    if (newPassword && confirmPassword) {
        newPassword.addEventListener('input', validatePasswords);
        confirmPassword.addEventListener('input', validatePasswords);
    }
});
</script>
{% endblock %}
